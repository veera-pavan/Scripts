  # Agent VM image name
pool:
 name: 'azureagent'


variables:
  # Link the variable group containing the Terraform secrets
  - group: TerraformVariables

steps:
- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      # Clone the GitHub repository
      git clone https://github.com/veera-pavan/Scripts.git
      ls
      

  displayName: 'Clone Repository'
  env:
    GITHUB_PAT: $(GITHUB_PAT)

- script: |
    echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$(ARM_CLIENT_ID)"
    echo "##vso[task.setvariable variable=ARM_CLIENT_SECRET]$(ARM_CLIENT_SECRET)"
    echo "##vso[task.setvariable variable=ARM_TENANT_ID]$(ARM_TENANT_ID)"
    echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$(ARM_SUBSCRIPTION_ID)"
  displayName: 'Set Terraform Service Principal Variables'

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |

      git checkout testbranch 
      ls
      cd ./CICD_Project/VM_creation
      pwd
      ls

      # Export the environment variables for Terraform
      export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
      export ARM_CLIENT_SECRET=$(ARM_CLIENT_SECRET)
      export ARM_TENANT_ID=$(ARM_TENANT_ID)
      export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)
      
      # installed terraform version
      terraform -v
      pwd

      # Initialize Terraform
      terraform init

      # Plan and apply Terraform configuration
      terraform plan
      terraform apply -auto-approve
  displayName: 'Run Terraform'
