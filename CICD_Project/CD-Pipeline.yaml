  # Agent VM image name
pool:
 name: 'azureagent'


variables:
  # Link the variable group containing the Terraform secrets
  - group: TerraformVariables

steps:
- script: |
    echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$(ARM_CLIENT_ID)"
    echo "##vso[task.setvariable variable=ARM_CLIENT_SECRET]$(ARM_CLIENT_SECRET)"
    echo "##vso[task.setvariable variable=ARM_TENANT_ID]$(ARM_TENANT_ID)"
    echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$(ARM_SUBSCRIPTION_ID)"
  displayName: 'Set Terraform Service Principal Variables'

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      # Export the environment variables for Terraform
      export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
      export ARM_CLIENT_SECRET=$(ARM_CLIENT_SECRET)
      export ARM_TENANT_ID=$(ARM_TENANT_ID)
      export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)
      
      # installed terraform version
      terraform -v
      pwd

      # Initialize Terraform
      terraform init

      # Plan and apply Terraform configuration
      terraform plan
      terraform apply -auto-approve
  displayName: 'Run Terraform'
